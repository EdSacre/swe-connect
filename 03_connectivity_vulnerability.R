# Import packages
library(terra)
library(rio)
library(Matrix)
options(scipen = 999)

# This script can safely be looped as it is much quicker to run than the previous scripts
for(i in 1:16){
  
  # Define extent
  ex <- c(350000, 1000000, 6091807, 7424396) # full extent
  
  # Specify output directory
  outdir <- "outputs/connectivity_vulnerability/"
  if(!dir.exists(outdir)){dir.create(outdir)}
  
  # Import species spreadsheet
  meta <- rio::import("spec_list.xlsx", sheet = "species")
  specname <- meta$code[i]
  grid <- rast("grid.tif")
  
  # Import species habitats
  spec <- rast(paste0("./inputs/habs_standard/", specname, ".tif"))
  spec[is.na(grid)] <- NA
  
  # Import connectivity matrix without pressures
  p1 <- paste0(".*con_", specname, ".*\\.mtx$")
  l1 <- list.files("outputs/connectivity_matrices", pattern = p1, full.names = TRUE, recursive = T)
  l1 <- l1[grepl("presFALSE", l1)]
  if(identical(l1, character(0))){next}
  matPF <- readMM(l1)
  
  # Import connectivity matrix with pressures
  p1 <- paste0(".*con_", specname, ".*\\.mtx$")
  l1 <- list.files("outputs/connectivity_matrices", pattern = p1, full.names = TRUE, recursive = T)
  l1 <- l1[grepl("presTRUE", l1)]
  if(identical(l1, character(0))){next}
  matPT <- readMM(l1)
  
  # Calculate the decline in connectivity in each pixel in response to pressures
  # This is proportional to the number of individuals that would fail to reach each pixel
  # due to hindrance by physical disturbance compared to the unperturbed network
  # Such habitat pixels should be a higher conservation priority because they may not be 
  # replenished in the event of local extirpation from e.g. fishing activities.
  
  # NOTE: Row sums calculate how much connectivity each habitat cell PROVIDES
  # NOTE: Column sums calculate how much connectivity each habitat cell RECIEVES
  # Calculate over 3 generations
  matPF <- matPF %*% matPF %*% matPF # modify the number of generations here
  matPT <- matPT %*% matPT %*% matPT # modify the number of generations here
  
  sink_str_PF <- colSums(matPF) # Sink strength without pressures
  sink_str_PT <- colSums(matPT) # Sink strength with pressures
  sink_delta <- sink_str_PF - sink_str_PT # Difference between the two
  sink_delta[sink_delta < 0] <- 0 # Remove small rounding errors
  sink_delta <- sink_delta / max(sink_delta) # Scale from 0 to 1
  
  # Add to spatial raster
  spec_sink_delta <- spec
  spec_sink_delta[!is.na(spec_sink_delta)] <- sink_delta
  spec_sink_delta[is.na(spec_sink_delta)] <- 0
  spec_sink_delta[is.na(grid)] <- NA
  
  # Export files
  outfile <- paste0(outdir, "/", specname, "_con_vulnerability.tif")
  writeRaster(spec_sink_delta, outfile, overwrite = TRUE)
  cat("\nIteration", i, "complete - Species:", meta$english[i], " - Species code: ", meta$code[i])
}
